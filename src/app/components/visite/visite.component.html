<app-header></app-header>
<app-sidebar></app-sidebar>

<main id="main" class="main">

  <h3>A propos les visites</h3>
  <section class="section visit-info">
    <!-- Tab View Card -->
    <div class="col-12">
      <!-- Collapsible Tab Panel Section -->
      <div id="visitInfoCollapse" class="collapse show">
        <div class="card-body">
          <div class="p_fluid">
            <p-tabView [(activeIndex)]="activeTabIndex">
              <p-tabPanel header="General Information">
                <div class="form-container">
                  <!-- Patient Selection -->
                  <div class="form-group">
                    <div class="form-group">
                      <label for="patient">Patient <span class="required">*</span></label>
                      <p-dropdown [options]="patients" [(ngModel)]="selectedPatient" placeholder="Select a Patient"
                        (onChange)="onPatientSelected()" optionLabel="nom" [virtualScroll]="true" [itemSize]="30">
                      </p-dropdown>
                    </div>



                  </div>

                  <!-- Visit Date/Time -->
                  <div class="form-group">
                    <label for="date">Visit Date/Time <span class="required">*</span></label>
                    <p-calendar [(ngModel)]="visitDateTime" [showTime]="true" dateFormat="dd/mm/yy" [minDate]="today"
                      [style]="{width: '100%'}">
                    </p-calendar>
                  </div>

                  <!-- Symptoms -->
                  <div class="form-group observation-field">
                    <label for="symptoms">Symptoms/Reason for Visit</label>
                    <textarea rows="4" [(ngModel)]="symptoms"
                      placeholder="Describe the symptoms or reason for the visit..." [style]="{width: '100%'}">
                            </textarea>
                  </div>
                  <!-- Bouton Next -->
                  <div class="form-actions button-field center">
                    <button pButton type="button" label="Next" (click)="goToNextTab()"
                      class="p-button-raised p_btn rounded-button">
                    </button>
                  </div>
                </div>
              </p-tabPanel>
              <p-tabPanel header="Ordonnance">
                <div class="form-container">
                  <div *ngIf="categories.length > 0">
                    <!-- Medication Input Section (shown before finalization) -->
                    <div *ngIf="!medicationsFinalized">
                      <div *ngFor="let medication of medications; let i = index" class="medication-row">
                        <!-- Category Dropdown -->
                        <div class="form-group">
                          <label for="category-{{ i }}">Catégorie</label>
                          <p-dropdown [options]="categories" [(ngModel)]="medications[i].category"
                            (onChange)="onCategoryChange(i)" placeholder="Select Category"
                            [style]="{ width: '100%' }"></p-dropdown>
                        </div>
                        <!-- Medication Name Dropdown -->
                        <div class="form-group">
                          <label for="medication-{{ i }}">Médicament</label>
                          <p-dropdown [options]="getMedicationsByCategory(medications[i].category)"
                            [(ngModel)]="medications[i].name" placeholder="Select Medication"
                            [style]="{ width: '100%' }">
                          </p-dropdown>
                        </div>
                        <!-- Dosage Input -->
                        <div class="form-group">
                          <label for="dosage-{{ i }}">Dosage</label>
                          <input id="dosage-{{ i }}" type="number" pInputText [(ngModel)]="medications[i].dosage"
                            placeholder="Dosage (mg)" [min]="1" required />
                        </div>
                        <!-- Actions -->
                        <div class="form-actions button-field">
                          <!-- Add another medication -->
                          <button pButton icon="pi pi-plus" class="icon-only-button" (click)="addMedication()"
                            [disabled]="medicationsFinalized"></button>
                          <!-- Finalize Medications -->
                          <button pButton label="" icon="pi pi-check" class="icon-only-button"
                            (click)="finalizeMedications()"></button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Ordonnance Table Section (shown after finalizing) -->
                <!-- Ordonnance Table Section -->
                <div class="form-section">
                  <div class="ordonnance-header">
                    <h4>Ordonnance</h4>
                    <button pButton icon="pi pi-print" class="icon-only-button" (click)="printOrdonnance()"
                      title="Imprimer l'Ordonnance">
                    </button>
                  </div>
                  <div *ngIf="finalMedications.length > 0">
                    <table class="p-datatable">
                      <thead>
                        <tr>
                          <th>Catégorie</th>
                          <th>Médicament</th>
                          <th>Dosage</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let med of finalMedications; let j = index">
                          <!-- Display Category Name -->
                          <td>{{ med.category?.nom }}</td>
                          <!-- Display Medication Name -->
                          <td>{{ med.name?.nom }}</td>
                          <td>{{ med.dosage }}</td>
                          <td>

                            <button pButton icon="pi pi-trash"
                              class="p-button-rounded p-button-danger p-button-outlined" (click)="removeMedication(j)"
                              title="Supprimer ce médicament"></button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div *ngIf="finalMedications.length === 0">
                    <p>Aucun médicament finalisé.</p>
                  </div>
                </div>
                <!-- Bouton Next -->
                <div class="form-actions button-field">
                  <!-- <button 
                              pButton 
                              type="button" 
                              label="Next" 
                              (click)="goToNextTab()"
                              class="p-button-raised p_btn rounded-button">
                            </button> -->
                  <button pButton type="button" label="Enregistrer visite" (click)="save()"
                    class="p-button-raised p-button-success rounded-button" [disabled]="!savedOrdonnanceId">
                  </button>
                </div>
              </p-tabPanel>
              <!-- <p-tabPanel header="Scans/Tests">
                        <div class="form-container">
                          <div class="form-group">
                            <label for="scan">Ajouter un Scan/Test</label>
                            <p-dropdown
                              id="scan"
                              [options]="scansList"
                              [(ngModel)]="selectedScan"
                              placeholder="Sélectionner un test"
                              class="p-fluid"
                            ></p-dropdown>
                          </div>
                          <div class="form-group">
                            <label for="upload">Télécharger les Résultats</label>
                            <input
                              id="upload"
                              type="file"
                              class="p-inputtext"
                              (change)="onFileUpload($event)"
                            />
                          </div>
                          <div class="form-group">
                            <label for="testDate">Date et Heure du Test</label>
                            <p-calendar
                              id="testDate"
                              [(ngModel)]="testDateTime"
                              [showTime]="true"
                              class="p-fluid"
                            ></p-calendar>
                          </div>
                        </div>
                      </p-tabPanel>
                       -->

              <!-- Payment Tab -->
              <!-- <p-tabPanel header="Payment">
                        <div class="p-field">
                          <label for="paymentStatus">Payment Status</label>
                          <p-dropdown [options]="paymentStatuses" [(ngModel)]="paymentStatus" placeholder="Select Status"></p-dropdown>
                        </div>
                        <div class="p-field">
                          <label for="paymentMethod">Payment Method</label>
                          <p-dropdown [options]="paymentMethods" [(ngModel)]="paymentMethod" placeholder="Select Method"></p-dropdown>
                        </div>
                        <div class="p-field">
                          <label for="amount">Amount</label>
                          <input type="number" [(ngModel)]="paymentAmount" placeholder="Enter Amount">
                        </div>
                      </p-tabPanel>
                   -->
              <p-tabPanel header="Historique des Visites ">
                <div class="visit-history-container">
                  <!-- Header Section -->
                  <div class="visit-history-header">
                    <p>
                      Consultez les détails des visites précédentes de
                      <span class="text-primary fw-bold">{{ selectedPatient?.nom }} {{ selectedPatient?.prenom
                        }}</span>,
                      y compris les diagnostics et ordonnances.
                    </p>
                  </div>

                  <!-- Visit History Table -->
                  <div class="visit-history-table">
                    <p-table [value]="filteredVisitHistory" [paginator]="true" [rows]="5" class="p-datatable">
                      <ng-template pTemplate="header">
                        <tr>
                          <th>Date de Visite</th>
                          <th>Diagnostic</th>
                          <th>Ordonnance</th>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="body" let-visit>
                        <tr>
                          <td>{{ visit.dateVisite | date: 'dd/MM/yyyy' }}</td>
                          <td>{{ visit.motif }}</td>
                          <td>
                            <button *ngIf="visit.ordonnanceDetails" class="btn btn-primary btn-sm"
                              (click)="openOrdonnanceModal(visit)">
                              Voir Ordonnance
                            </button>
                            <span *ngIf="!visit.ordonnanceDetails" class="text-muted">
                              Aucune ordonnance
                            </span>
                          </td>
                        </tr>
                      </ng-template>
                    </p-table>

                  </div>
                </div>
              </p-tabPanel>


            </p-tabView>
          </div>

        </div>
      </div>
    </div>



  </section>

</main>
<app-footer></app-footer>